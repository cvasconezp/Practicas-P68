<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Pr√°cticas Estudiantiles</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ESTILOS CSS - Dise√±o Responsivo y Moderno */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px; text-align: center; position: relative; }
        .header h1 { color: #667eea; margin-bottom: 10px; font-size: 24px; }
        
        /* Bot√≥n Admin discreto */
        .admin-login-btn { position: absolute; top: 20px; right: 20px; padding: 8px 16px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 6px; color: #667eea; font-size: 13px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .admin-login-btn:hover { background: rgba(102, 126, 234, 0.2); border-color: #667eea; transform: translateY(-1px); }
        
        /* √Åreas de contenido */
        .content-area { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; }
        .content-area.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .section:last-child { border-bottom: none; }
        .section h2 { color: #667eea; margin-bottom: 20px; font-size: 20px; }
        
        /* Upload areas */
        .upload-area { border: 2px dashed #667eea; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 15px; background: #f8f9ff; transition: all 0.3s; }
        .upload-area:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-area input[type="file"] { display: none; }
        .file-info { margin-top: 10px; font-size: 13px; color: #666; }
        
        /* Formularios */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        
        /* Botones */
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin-right: 10px; display: inline-block; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .upload-btn { background: #667eea; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; }
        
        /* Resultados y Tablas */
        .result-card { background: #f8f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .data-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e0e0e0; }
        .data-label { font-weight: 600; color: #555; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        /* Pasos */
        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .step-indicator::before { content: ''; position: absolute; top: 20px; left: 0; right: 0; height: 2px; background: #e0e0e0; z-index: 0; }
        .step { flex: 1; text-align: center; position: relative; z-index: 1; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #666; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 5px; background: white; border: 2px solid #e0e0e0; }
        .step.active .step-number { background: #667eea; color: white; border-color: #667eea; }
        .step.completed .step-number { background: #28a745; color: white; border-color: #28a745; }
        .step-label { font-size: 12px; color: #666; font-weight: 600; }
        
        .hidden { display: none; }
        
        /* Admin Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-card h3 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
        
        /* Preview Table */
        .data-preview { max-height: 300px; overflow-y: auto; margin-top: 15px; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8f9ff; padding: 10px; text-align: left; position: sticky; top: 0; }
        td { padding: 8px 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="admin-login-btn" onclick="switchMode('admin')">‚öôÔ∏è Admin</button>
            <h1>Gesti√≥n de Pr√°cticas</h1>
            <p>Universidad Polit√©cnica Salesiana - Educaci√≥n Intercultural Biling√ºe</p>
        </div>

        <div id="admin-panel" class="content-area">
            <div id="adminLogin" class="section">
                <h2>üîê Acceso Administrativo</h2>
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label>ID:</label>
                        <input type="text" id="adminId">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="adminPassword">
                    </div>
                    <button class="btn btn-primary" style="width: 100%;" onclick="adminLogin()">Ingresar</button>
                    <div id="loginError" style="margin-top: 10px;"></div>
                </div>
            </div>

            <div id="adminContent" class="hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Panel de Control</h3>
                    <button class="btn btn-secondary" onclick="adminLogout()">Salir</button>
                </div>

                <div class="section">
                    <h2>1. Configuraci√≥n de Conexi√≥n</h2>
                    <div class="alert alert-info">Pega aqu√≠ la URL de tu Web App de Google Apps Script (Debe terminar en /exec)</div>
                    <div class="form-group">
                        <input type="url" id="googleSheetsUrl" placeholder="https://script.google.com/macros/s/..../exec">
                    </div>
                    <button class="btn btn-primary" onclick="saveGoogleSheetsUrl()">üíæ Guardar URL</button>
                </div>

                <div class="section">
                    <h2>2. Carga Masiva de Datos</h2>
                    <div class="upload-area">
                        <p>üìÇ <strong>Estudiantes</strong> (Excel)</p>
                        <input type="file" id="studentFile" accept=".xlsx, .xls">
                        <button class="upload-btn" onclick="document.getElementById('studentFile').click()">Seleccionar Archivo</button>
                        <div id="studentFileInfo" class="file-info"></div>
                    </div>
                    <div class="upload-area">
                        <p>üè´ <strong>Escuelas</strong> (Excel)</p>
                        <input type="file" id="schoolFile" accept=".xlsx, .xls">
                        <button class="upload-btn" onclick="document.getElementById('schoolFile').click()">Seleccionar Archivo</button>
                        <div id="schoolFileInfo" class="file-info"></div>
                    </div>
                    <button class="btn btn-success hidden" id="processBtn" onclick="processUploadedData()">üöÄ Procesar y Sincronizar con Google</button>
                </div>

                <div class="section">
                    <h2>3. Estado del Sistema</h2>
                    <div class="stats">
                        <div class="stat-card"><h3 id="statStudents">0</h3><p>Estudiantes</p></div>
                        <div class="stat-card"><h3 id="statSchools">0</h3><p>Escuelas</p></div>
                        <div class="stat-card"><h3 id="statSubmissions">0</h3><p>Registros</p></div>
                    </div>
                    <div id="loadedDataPreview"></div>
                </div>
                
                <div class="section">
                    <button class="btn btn-success" onclick="exportData()">üì• Descargar Reporte CSV</button>
                </div>
            </div>
        </div>

        <div id="student-panel" class="content-area active">
            <div class="step-indicator">
                <div class="step active" id="step1"><div class="step-number">1</div><div class="step-label">ID</div></div>
                <div class="step" id="step2"><div class="step-number">2</div><div class="step-label">Datos</div></div>
                <div class="step" id="step3"><div class="step-number">3</div><div class="step-label">Escuela</div></div>
                <div class="step" id="step4"><div class="step-number">4</div><div class="step-label">Rector</div></div>
                <div class="step" id="step5"><div class="step-number">5</div><div class="step-label">Fin</div></div>
            </div>

            <div id="step1-content" class="section">
                <div id="loadingIndicator" class="alert alert-info" style="display:none;">‚è≥ Conectando con la base de datos...</div>
                <h2>Identificaci√≥n</h2>
                <div class="form-group">
                    <label>Ingresa tu n√∫mero de c√©dula o ID:</label>
                    <input type="text" id="studentIdInput" placeholder="Ej: 010xxxxxxx">
                </div>
                <button class="btn btn-primary" onclick="searchStudent()">Buscar Estudiante</button>
                <div id="searchError" style="margin-top: 10px;"></div>
            </div>

            <div id="step2-content" class="section hidden">
                <h2>Datos Personales</h2>
                <div class="result-card" id="studentDataDisplay"></div>
                
                <div class="form-group">
                    <label>Correo Personal: <span style="color:red">*</span></label>
                    <input type="email" id="studentEmail" required>
                </div>
                <div class="form-group">
                    <label>Celular (WhatsApp): <span style="color:red">*</span></label>
                    <input type="tel" id="studentPhone" maxlength="10" placeholder="09xxxxxxxx">
                </div>
                <div class="form-group">
                    <label>Centro de Apoyo: <span style="color:red">*</span></label>
                    <select id="studentCenter">
                        <option value="">-- Seleccionar --</option>
                        <option value="Cayambe">Cayambe</option>
                        <option value="Latacunga">Latacunga</option>
                        <option value="Otavalo">Otavalo</option>
                        <option value="Riobamba">Riobamba</option>
                        <option value="Quito">Quito</option>
                        <option value="Guayaquil">Guayaquil</option>
                        <option value="Cuenca">Cuenca</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nivel y Pr√°ctica: <span style="color:red">*</span></label>
                    <select id="studentLevel">
                        <option value="">-- Seleccionar --</option>
                        <option value="2do Nivel - Acercamiento">2do Nivel - Acercamiento</option>
                        <option value="4to Nivel - Modelos Pedag√≥gicos">4to Nivel - Modelos Pedag√≥gicos</option>
                        <option value="6to Nivel - Servicio Comunitario">6to Nivel - Servicio Comunitario</option>
                        <option value="8vo Nivel - Profesional">8vo Nivel - Profesional</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="showStep(1)">Atr√°s</button>
                <button class="btn btn-primary" onclick="validateStep2()">Siguiente</button>
            </div>

            <div id="step3-content" class="section hidden">
                <h2>Datos de la Instituci√≥n</h2>
                <div class="form-group">
                    <label>C√≥digo AMIE de la Escuela:</label>
                    <input type="text" id="schoolAmieInput" placeholder="Ej: 17H00xxx">
                </div>
                <button class="btn btn-primary" onclick="searchSchool()">Buscar Escuela</button>
                <button class="btn btn-secondary" onclick="showStep(2)">Atr√°s</button>
                <div id="schoolError" style="margin-top: 10px;"></div>
            </div>

            <div id="step4-content" class="section hidden">
                <h2>Confirmaci√≥n de Escuela</h2>
                <div class="result-card" id="schoolDataDisplay"></div>
                
                <h3>Datos de la Autoridad (Rector/L√≠der)</h3>
                <div class="form-group">
                    <label>Nombre Completo de la Autoridad: <span style="color:red">*</span></label>
                    <input type="text" id="authName">
                </div>
                <div class="form-group">
                    <label>Cargo: <span style="color:red">*</span></label>
                    <select id="authRole">
                        <option value="Rector/a">Rector/a</option>
                        <option value="Director/a">Director/a</option>
                        <option value="L√≠der Educativo">L√≠der Educativo</option>
                        <option value="Vicerrector/a">Vicerrector/a</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tel√©fono de Contacto Autoridad: <span style="color:red">*</span></label>
                    <input type="tel" id="authPhone" maxlength="10">
                </div>
                
                <button class="btn btn-secondary" onclick="showStep(3)">Atr√°s</button>
                <button class="btn btn-success" onclick="submitFinalForm()">‚úÖ Finalizar y Enviar</button>
            </div>

            <div id="step5-content" class="section hidden">
                <div class="alert alert-success">
                    <h2>¬°Registro Exitoso!</h2>
                    <p>Tus datos han sido guardados correctamente en el sistema.</p>
                </div>
                <button class="btn btn-primary" onclick="location.reload()">Nuevo Registro</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN Y VARIABLES ---
        let GOOGLE_SHEETS_URL = localStorage.getItem('googleSheetsUrl') || '';
        const ADMIN_ID = '1722769070';
        const ADMIN_PASSWORD = '1722769070';
        
        // Memoria local
        let studentsDB = [];
        let schoolsDB = [];
        let submissionsDB = [];
        
        // Estado temporal del formulario
        let currentStudent = null;
        let currentSchool = null;

        // AL CARGAR LA P√ÅGINA
        window.onload = function() {
            loadFromLocalStorage();
            checkAdminSession();
            
            // Si hay URL configurada, descargamos datos frescos autom√°ticamente
            if(GOOGLE_SHEETS_URL) {
                downloadDataFromCloud();
            } else {
                console.log("‚ö†Ô∏è URL no configurada. Solo datos locales.");
            }
        };

        // --- 1. COMUNICACI√ìN CON GOOGLE SHEETS (SOLUCI√ìN CORS) ---
        // Usamos POST + text/plain para evitar errores Preflight (OPTIONS 405)
        
        async function apiRequest(data) {
            if(!GOOGLE_SHEETS_URL) return null;
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'cors', // Clave para leer respuesta
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8' // Clave para evitar bloqueo
                    },
                    body: JSON.stringify(data)
                });
                return await response.json();
            } catch (error) {
                console.error("Error de API:", error);
                return { result: 'error', message: error.toString() };
            }
        }

        async function downloadDataFromCloud() {
            const indicator = document.getElementById('loadingIndicator');
            if(indicator) indicator.style.display = 'block';

            // 1. Descargar Estudiantes
            const resStudents = await apiRequest({ operation: 'loadStudents' });
            if(resStudents && resStudents.result === 'success') {
                studentsDB = resStudents.data;
                console.log(`‚úÖ ${studentsDB.length} estudiantes descargados.`);
            }

            // 2. Descargar Escuelas
            const resSchools = await apiRequest({ operation: 'loadSchools' });
            if(resSchools && resSchools.result === 'success') {
                schoolsDB = resSchools.data;
                console.log(`‚úÖ ${schoolsDB.length} escuelas descargadas.`);
            }

            saveToLocalStorage();
            updateStats();
            if(indicator) indicator.style.display = 'none';
        }

        async function syncDataToCloud(type, dataArray) {
            const res = await apiRequest({
                operation: type === 'students' ? 'saveStudents' : 'saveSchools',
                [type]: dataArray
            });
            if(res && res.result === 'success') {
                alert(`Sincronizaci√≥n exitosa: ${res.message}`);
            } else {
                alert("Error al sincronizar con la nube.");
            }
        }

        // --- 2. L√ìGICA DEL ESTUDIANTE ---

        function searchStudent() {
            const id = document.getElementById('studentIdInput').value.trim();
            // B√∫squeda insensible a tipos (string/number)
            currentStudent = studentsDB.find(s => String(s.id).trim() === id);

            if (currentStudent) {
                document.getElementById('studentDataDisplay').innerHTML = `
                    <div class="data-row"><span class="data-label">ID:</span> <span>${currentStudent.id}</span></div>
                    <div class="data-row"><span class="data-label">Nombre:</span> <span>${currentStudent.nombreCompleto}</span></div>
                `;
                // Prellenar datos si existen
                document.getElementById('studentEmail').value = currentStudent.correo || '';
                document.getElementById('studentPhone').value = currentStudent.telefono || '';
                
                document.getElementById('searchError').innerHTML = '';
                showStep(2);
            } else {
                showAlert('searchError', '‚ùå ID no encontrado. Contacta al administrador.', 'error');
            }
        }

        function validateStep2() {
            const email = document.getElementById('studentEmail').value;
            const phone = document.getElementById('studentPhone').value;
            const center = document.getElementById('studentCenter').value;
            const level = document.getElementById('studentLevel').value;

            if(!email.includes('@') || phone.length < 9 || !center || !level) {
                alert("Por favor completa todos los campos obligatorios correctamente.");
                return;
            }

            // Guardar datos temporales
            currentStudent.correo = email;
            currentStudent.telefono = phone;
            currentStudent.centroApoyo = center;
            currentStudent.nivelPractica = level;
            
            showStep(3);
        }

        function searchSchool() {
            const amie = document.getElementById('schoolAmieInput').value.trim().toUpperCase();
            currentSchool = schoolsDB.find(s => String(s.id).toUpperCase().trim() === amie);

            if (currentSchool) {
                document.getElementById('schoolDataDisplay').innerHTML = `
                    <div class="data-row"><span class="data-label">AMIE:</span> <span>${currentSchool.id}</span></div>
                    <div class="data-row"><span class="data-label">Nombre:</span> <span>${currentSchool.nombre}</span></div>
                    <div class="data-row"><span class="data-label">Distrito:</span> <span>${currentSchool.distrito}</span></div>
                    <div class="data-row"><span class="data-label">Sistema:</span> <span>${currentSchool.sistema}</span></div>
                `;
                document.getElementById('schoolError').innerHTML = '';
                showStep(4);
            } else {
                showAlert('schoolError', '‚ùå Escuela no encontrada. Verifica el c√≥digo AMIE.', 'error');
            }
        }

        async function submitFinalForm() {
            const authName = document.getElementById('authName').value;
            const authRole = document.getElementById('authRole').value;
            const authPhone = document.getElementById('authPhone').value;

            if(!authName || !authPhone) {
                alert("Completa los datos de la autoridad.");
                return;
            }

            // Construir objeto final
            const finalRecord = {
                timestamp: new Date().toISOString(),
                fecha_hora: new Date().toLocaleString(),
                estudiante_id: currentStudent.id,
                estudiante_nombre_completo: currentStudent.nombreCompleto,
                estudiante_correo: currentStudent.correo,
                estudiante_telefono: currentStudent.telefono,
                estudiante_centro_apoyo: currentStudent.centroApoyo,
                estudiante_nivel_practica: currentStudent.nivelPractica,
                escuela_amie: currentSchool.id,
                escuela_nombre: currentSchool.nombre,
                escuela_distrito: currentSchool.distrito,
                escuela_sistema: currentSchool.sistema,
                autoridad_nombre: authName,
                autoridad_cargo: authRole,
                autoridad_telefono: authPhone
            };

            // Guardar localmente
            submissionsDB.push(finalRecord);
            saveToLocalStorage();

            // Enviar a Google
            const btn = document.querySelector('#step4-content .btn-success');
            const originalText = btn.innerText;
            btn.innerText = "Enviando...";
            btn.disabled = true;

            const res = await apiRequest(finalRecord); // El backend detecta que es un submit por defecto
            
            btn.innerText = originalText;
            btn.disabled = false;

            if(res && res.result === 'success') {
                showStep(5);
            } else {
                alert("Hubo un error de conexi√≥n, pero tus datos se guardaron localmente.");
                showStep(5);
            }
        }

        // --- 3. L√ìGICA DE ADMINISTRADOR ---

        function adminLogin() {
            const u = document.getElementById('adminId').value;
            const p = document.getElementById('adminPassword').value;
            if(u === ADMIN_ID && p === ADMIN_PASSWORD) {
                localStorage.setItem('adminLoggedIn', 'true');
                checkAdminSession();
            } else {
                showAlert('loginError', 'Credenciales incorrectas', 'error');
            }
        }

        function checkAdminSession() {
            if(localStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                document.getElementById('googleSheetsUrl').value = GOOGLE_SHEETS_URL;
                updateStats();
            }
        }

        function adminLogout() {
            localStorage.removeItem('adminLoggedIn');
            location.reload();
        }

        function saveGoogleSheetsUrl() {
            const url = document.getElementById('googleSheetsUrl').value;
            if(!url.endsWith('/exec')) {
                alert("La URL debe terminar en /exec");
                return;
            }
            localStorage.setItem('googleSheetsUrl', url);
            GOOGLE_SHEETS_URL = url;
            alert("URL Guardada. Intentando conectar...");
            downloadDataFromCloud();
        }

        // Procesamiento de Excel (SheetJS)
        function processUploadedData() {
            const fileS = document.getElementById('studentFile').files[0];
            const fileSc = document.getElementById('schoolFile').files[0];

            if(!fileS || !fileSc) {
                alert("Por favor sube AMBOS archivos.");
                return;
            }

            const readerS = new FileReader();
            readerS.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                // Mapeo inteligente
                studentsDB = data.map(row => ({
                    id: String(findCol(row, ['id', 'cedula', 'identificacion']) || ''),
                    nombreCompleto: findCol(row, ['nombre', 'estudiante', 'nombres']) || '',
                    correo: findCol(row, ['correo', 'email']) || '',
                    telefono: String(findCol(row, ['telefono', 'celular']) || '')
                }));

                // Ahora escuelas
                const readerSc = new FileReader();
                readerSc.onload = (e2) => {
                    const wb2 = XLSX.read(new Uint8Array(e2.target.result), {type: 'array'});
                    const data2 = XLSX.utils.sheet_to_json(wb2.Sheets[wb2.SheetNames[0]]);
                    
                    schoolsDB = data2.map(row => ({
                        id: String(findCol(row, ['amie', 'codigo', 'id']) || ''),
                        nombre: findCol(row, ['nombre', 'institucion', 'escuela']) || '',
                        distrito: findCol(row, ['distrito']) || '',
                        sistema: findCol(row, ['sistema', 'sostenimiento']) || ''
                    }));

                    saveToLocalStorage();
                    updateStats();
                    
                    // Sincronizar con Google
                    syncDataToCloud('students', studentsDB);
                    syncDataToCloud('schools', schoolsDB);
                };
                readerSc.readAsArrayBuffer(fileSc);
            };
            readerS.readAsArrayBuffer(fileS);
        }

        function findCol(row, keywords) {
            const keys = Object.keys(row);
            for(let kw of keywords) {
                const found = keys.find(k => k.toLowerCase().includes(kw));
                if(found) return row[found];
            }
            return '';
        }

        function updateStats() {
            document.getElementById('statStudents').innerText = studentsDB.length;
            document.getElementById('statSchools').innerText = schoolsDB.length;
            document.getElementById('statSubmissions').innerText = submissionsDB.length;
            
            // Preview simple
            document.getElementById('loadedDataPreview').innerHTML = `
                <div class="alert alert-info">
                    Base de Datos Local: <br>
                    <strong>${studentsDB.length}</strong> Estudiantes | 
                    <strong>${schoolsDB.length}</strong> Escuelas
                </div>`;
        }

        function exportData() {
            if(submissionsDB.length === 0) return alert("No hay registros para exportar");
            const csv = Papa.unparse(submissionsDB);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "reporte_practicas.csv";
            link.click();
        }

        // --- UTILIDADES ---
        
        function switchMode(mode) {
            if(mode === 'admin') {
                document.getElementById('student-panel').classList.remove('active');
                document.getElementById('admin-panel').classList.add('active');
                if(!localStorage.getItem('adminLoggedIn')) {
                    document.getElementById('adminLogin').classList.remove('hidden');
                    document.getElementById('adminContent').classList.add('hidden');
                }
            } else {
                document.getElementById('admin-panel').classList.remove('active');
                document.getElementById('student-panel').classList.add('active');
            }
        }

        function showStep(n) {
            for(let i=1; i<=5; i++) {
                document.getElementById(`step${i}-content`).classList.add('hidden');
                const indicator = document.getElementById(`step${i}`);
                indicator.className = 'step';
                if(i < n) indicator.classList.add('completed');
                if(i === n) indicator.classList.add('active');
            }
            document.getElementById(`step${n}-content`).classList.remove('hidden');
        }

        function showAlert(id, msg, type) {
            document.getElementById(id).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
        }

        function saveToLocalStorage() {
            localStorage.setItem('studentsDB', JSON.stringify(studentsDB));
            localStorage.setItem('schoolsDB', JSON.stringify(schoolsDB));
            localStorage.setItem('submissionsDB', JSON.stringify(submissionsDB));
        }

        function loadFromLocalStorage() {
            studentsDB = JSON.parse(localStorage.getItem('studentsDB') || '[]');
            schoolsDB = JSON.parse(localStorage.getItem('schoolsDB') || '[]');
            submissionsDB = JSON.parse(localStorage.getItem('submissionsDB') || '[]');
        }

        // Listeners visuales para input file
        document.getElementById('studentFile').onchange = (e) => document.getElementById('studentFileInfo').innerText = e.target.files[0].name;
        document.getElementById('schoolFile').onchange = (e) => {
            document.getElementById('schoolFileInfo').innerText = e.target.files[0].name;
            document.getElementById('processBtn').classList.remove('hidden');
        };

    </script>
</body>
</html>
