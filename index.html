<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pr√°cticas - UPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ESTILOS (Dise√±o Original Mantenido) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        
        /* Header */
        .header { background: #fff; padding: 30px; text-align: center; border-bottom: 1px solid #eee; position: relative; }
        .header h1 { color: #667eea; margin: 0; font-size: 24px; }
        .header p { color: #666; margin-top: 5px; font-size: 14px; }
        .admin-btn { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid #ddd; padding: 5px 10px; border-radius: 5px; cursor: pointer; color: #666; font-size: 12px; }
        
        /* Contenido */
        .content { padding: 30px; }
        
        /* Pasos */
        .steps { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .steps::before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: #eee; z-index: 0; }
        .step { position: relative; z-index: 1; background: #eee; color: #999; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; transition: all 0.3s; }
        .step.active { background: #667eea; color: white; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2); }
        .step.done { background: #48bb78; color: white; }

        /* Formularios */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: 0.3s; }
        .form-control:focus { border-color: #667eea; outline: none; }
        
        /* Botones */
        .btn { display: inline-block; padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: 0.2s; width: 100%; margin-top: 10px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-secondary { background: #cbd5e0; color: #4a5568; margin-top: 10px; }
        .btn-success { background: #48bb78; color: white; }
        
        /* Paneles */
        .hidden { display: none; }
        .card { background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; margin-bottom: 20px; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .data-label { font-weight: 600; color: #718096; }
        
        /* Mensajes */
        .alert { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 500; }
        .alert-info { background: #ebf8ff; color: #2b6cb0; }
        .alert-error { background: #fff5f5; color: #c53030; }
        .alert-success { background: #f0fff4; color: #2f855a; }

        /* Admin Styles */
        .admin-panel { background: #fff; border-top: 5px solid #667eea; }
        .upload-zone { border: 2px dashed #cbd5e0; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 15px; background: #f8fafc; }
        .file-status { font-size: 12px; color: #48bb78; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button class="admin-btn" onclick="toggleAdmin()">‚öôÔ∏è Admin</button>
        <h1>Gesti√≥n de Pr√°cticas</h1>
        <p>Educaci√≥n Intercultural Biling√ºe - UPS</p>
    </div>

    <div id="adminPanel" class="content hidden">
        <div id="adminLogin">
            <h2 style="text-align: center; color:#4a5568; margin-bottom:20px;">Acceso Administrativo</h2>
            <input type="password" id="adminPass" class="form-control" placeholder="Contrase√±a">
            <button class="btn btn-primary" onclick="adminLogin()">Ingresar</button>
        </div>

        <div id="adminTools" class="hidden">
            <h3 style="margin-bottom: 15px;">üì• Carga de Datos (Excel)</h3>
            
            <div class="upload-zone">
                <p><strong>1. Lista de Estudiantes</strong></p>
                <input type="file" id="fileStudents" accept=".xlsx" onchange="fileCheck('fileStudents', 'stat1')">
                <div id="stat1" class="file-status"></div>
            </div>

            <div class="upload-zone">
                <p><strong>2. Lista de Escuelas</strong></p>
                <input type="file" id="fileSchools" accept=".xlsx" onchange="fileCheck('fileSchools', 'stat2')">
                <div id="stat2" class="file-status"></div>
            </div>

            <button class="btn btn-success" id="btnUpload" onclick="procesarYSubir()">‚òÅÔ∏è Procesar y Subir a la Nube</button>
            <div id="uploadMsg" style="margin-top:15px;"></div>
            
            <hr style="margin: 20px 0;">
            <button class="btn btn-secondary" onclick="exportData()">üì• Descargar Reporte Final</button>
            <button class="btn btn-secondary" onclick="location.reload()">Salir</button>
        </div>
    </div>

    <div id="studentPanel" class="content">
        <div id="loading" class="alert alert-info">‚è≥ Conectando con la base de datos...</div>
        
        <div class="steps">
            <div id="s1" class="step active">1</div>
            <div id="s2" class="step">2</div>
            <div id="s3" class="step">3</div>
            <div id="s4" class="step">4</div>
        </div>

        <div id="view1">
            <div class="form-group">
                <label>Ingresa tu N√∫mero de C√©dula / ID:</label>
                <input type="text" id="studentId" class="form-control" placeholder="Ej: 010xxxxxxx">
            </div>
            <button class="btn btn-primary" onclick="buscarEstudiante()">üîç Buscar Estudiante</button>
            <div id="errorMsg" class="alert alert-error hidden" style="margin-top:15px;"></div>
        </div>

        <div id="view2" class="hidden">
            <div class="card" id="studentInfo"></div>
            
            <div class="form-group">
                <label>Correo Personal Actualizado:</label>
                <input type="email" id="email" class="form-control">
            </div>
            <div class="form-group">
                <label>N√∫mero de Celular (WhatsApp):</label>
                <input type="tel" id="phone" class="form-control" maxlength="10">
            </div>
            <div class="form-group">
                <label>Centro de Apoyo:</label>
                <select id="center" class="form-control">
                    <option value="">-- Seleccionar --</option>
                    <option>Cayambe</option><option>Latacunga</option><option>Otavalo</option>
                    <option>Riobamba</option><option>Quito</option><option>Guayaquil</option><option>Cuenca</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nivel y Pr√°ctica:</label>
                <select id="level" class="form-control">
                    <option value="">-- Seleccionar --</option>
                    <option>2do Nivel - Acercamiento</option>
                    <option>4to Nivel - Modelos Pedag√≥gicos</option>
                    <option>6to Nivel - Servicio Comunitario</option>
                    <option>8vo Nivel - Profesional</option>
                </select>
            </div>
            
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="nav(1)">Atr√°s</button>
                <button class="btn btn-primary" onclick="validarPaso2()">Siguiente</button>
            </div>
        </div>

        <div id="view3" class="hidden">
            <div class="form-group">
                <label>Ingresa el C√≥digo AMIE de la Escuela:</label>
                <input type="text" id="amie" class="form-control" placeholder="Ej: 17H00xxx">
            </div>
            <button class="btn btn-primary" onclick="buscarEscuela()">Buscar Escuela</button>
            <button class="btn btn-secondary" onclick="nav(2)">Atr√°s</button>
        </div>

        <div id="view4" class="hidden">
            <div class="card" id="schoolInfo"></div>
            
            <h3 style="color:#667eea; margin-bottom:15px;">Datos de la Autoridad</h3>
            <div class="form-group">
                <label>Nombre Completo (Rector/Director/L√≠der):</label>
                <input type="text" id="authName" class="form-control">
            </div>
            <div class="form-group">
                <label>Cargo:</label>
                <select id="authRole" class="form-control">
                    <option>Rector/a</option><option>Director/a</option><option>L√≠der Educativo</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tel√©fono de la Autoridad:</label>
                <input type="tel" id="authPhone" class="form-control" maxlength="10">
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="nav(3)">Atr√°s</button>
                <button class="btn btn-success" id="btnFinal" onclick="enviarFormulario()">‚úÖ Finalizar Registro</button>
            </div>
        </div>

        <div id="view5" class="hidden">
            <div class="alert alert-success">
                <h3>¬°Registro Completado!</h3>
                <p>Tus datos han sido enviados correctamente al sistema central.</p>
            </div>
            <button class="btn btn-primary" onclick="location.reload()">Nuevo Registro</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
    // ==========================================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwGvmpRo410Eazu2pwFiLeZA-NM8FM5AQ9GIpxGsvaZcx0VP8md888fwQOWe29q5K69/exec"; 
    // Ejemplo: const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx.../exec";

    // Variables Globales
    let dbStudents = [];
    let dbSchools = [];
    let formData = {};

    // 1. INICIALIZACI√ìN (Descarga autom√°tica)
    window.onload = async () => {
        if (SCRIPT_URL === "https://script.google.com/macros/s/AKfycbwGvmpRo410Eazu2pwFiLeZA-NM8FM5AQ9GIpxGsvaZcx0VP8md888fwQOWe29q5K69/exec" || SCRIPT_URL === "") {
            document.getElementById('loading').className = "alert alert-error";
            document.getElementById('loading').innerText = "‚ö†Ô∏è ERROR: El administrador no ha configurado la URL en el c√≥digo.";
            return;
        }

        try {
            // Descargar Estudiantes
            const reqEst = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ operation: 'loadStudents' })
            });
            const resEst = await reqEst.json();
            if(resEst.result === 'success') dbStudents = resEst.data;

            // Descargar Escuelas
            const reqEsc = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ operation: 'loadSchools' })
            });
            const resEsc = await reqEsc.json();
            if(resEsc.result === 'success') dbSchools = resEsc.data;

            document.getElementById('loading').classList.add('hidden');
            console.log("Datos cargados:", dbStudents.length, "estudiantes,", dbSchools.length, "escuelas.");

        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerText = "Error de conexi√≥n. Intenta recargar la p√°gina.";
            document.getElementById('loading').className = "alert alert-error";
        }
    };

    // 2. FUNCIONES DE ESTUDIANTE
    function buscarEstudiante() {
        const id = document.getElementById('studentId').value.trim();
        // Buscar en la memoria descargada
        const found = dbStudents.find(s => String(s.id).trim() === id);
        
        if (found) {
            formData.student = found;
            document.getElementById('studentInfo').innerHTML = `
                <div class="data-row"><span class="data-label">Estudiante:</span> ${found.nombreCompleto}</div>
                <div class="data-row"><span class="data-label">ID:</span> ${found.id}</div>
            `;
            // Prellenar
            document.getElementById('email').value = found.correo || '';
            document.getElementById('phone').value = found.telefono || '';
            document.getElementById('errorMsg').classList.add('hidden');
            nav(2);
        } else {
            showError("Estudiante no encontrado. Verifica tu ID.");
        }
    }

    function validarPaso2() {
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const center = document.getElementById('center').value;
        const level = document.getElementById('level').value;

        if(!email.includes('@') || phone.length < 9 || !center || !level) {
            return alert("Por favor completa todos los campos correctamente.");
        }
        
        formData.extra = { email, phone, center, level };
        nav(3);
    }

    function buscarEscuela() {
        const amie = document.getElementById('amie').value.trim().toUpperCase();
        const found = dbSchools.find(s => String(s.id).toUpperCase().trim() === amie);

        if (found) {
            formData.school = found;
            document.getElementById('schoolInfo').innerHTML = `
                <div class="data-row"><span class="data-label">Escuela:</span> ${found.nombre}</div>
                <div class="data-row"><span class="data-label">AMIE:</span> ${found.id}</div>
                <div class="data-row"><span class="data-label">Distrito:</span> ${found.distrito}</div>
            `;
            nav(4);
        } else {
            alert("Escuela no encontrada con ese c√≥digo AMIE.");
        }
    }

    async function enviarFormulario() {
        const authName = document.getElementById('authName').value;
        const authPhone = document.getElementById('authPhone').value;
        
        if(!authName || !authPhone) return alert("Faltan datos de la autoridad");

        const btn = document.getElementById('btnFinal');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const payload = {
            timestamp: new Date(),
            fecha_hora: new Date().toLocaleString(),
            estudiante_id: formData.student.id,
            estudiante_nombre_completo: formData.student.nombreCompleto,
            estudiante_correo: formData.extra.email,
            estudiante_telefono: formData.extra.phone,
            estudiante_centro_apoyo: formData.extra.center,
            estudiante_nivel_practica: formData.extra.level,
            escuela_amie: formData.school.id,
            escuela_nombre: formData.school.nombre,
            escuela_distrito: formData.school.distrito,
            escuela_sistema: formData.school.sistema,
            autoridad_nombre: authName,
            autoridad_cargo: document.getElementById('authRole').value,
            autoridad_telefono: authPhone
        };

        try {
            const req = await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(payload)
            });
            const res = await req.json();
            
            if(res.result === 'success') {
                nav(5);
            } else {
                alert("Error al guardar: " + res.message);
                btn.disabled = false;
            }
        } catch (e) {
            alert("Error de red. Intenta de nuevo.");
            btn.disabled = false;
        }
    }

    // 3. FUNCIONES DE ADMIN
    async function procesarYSubir() {
        const f1 = document.getElementById('fileStudents').files[0];
        const f2 = document.getElementById('fileSchools').files[0];
        
        if(!f1 || !f2) return alert("Sube ambos archivos Excel");
        
        const msg = document.getElementById('uploadMsg');
        msg.innerHTML = "‚è≥ Leyendo archivos...";
        msg.className = "alert alert-info";

        try {
            const dataEst = await readExcel(f1);
            const cleanEst = dataEst.map(r => ({
                id: String(findCol(r, 'id') || ''),
                nombreCompleto: findCol(r, 'nombre') || findCol(r, 'estudiante') || '',
                correo: findCol(r, 'correo') || '',
                telefono: String(findCol(r, 'telefono') || findCol(r, 'celular') || '')
            }));

            const dataEsc = await readExcel(f2);
            const cleanEsc = dataEsc.map(r => ({
                id: String(findCol(r, 'amie') || findCol(r, 'id') || ''),
                nombre: findCol(r, 'nombre') || '',
                distrito: findCol(r, 'distrito') || '',
                sistema: findCol(r, 'sistema') || ''
            }));

            msg.innerHTML = "üöÄ Subiendo a la nube... (Esto puede tardar unos segundos)";
            
            // Subir Estudiantes
            await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: {'Content-Type':'text/plain'},
                body: JSON.stringify({ operation: 'saveStudents', students: cleanEst })
            });

            // Subir Escuelas
            await fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: {'Content-Type':'text/plain'},
                body: JSON.stringify({ operation: 'saveSchools', schools: cleanEsc })
            });

            msg.innerHTML = "‚úÖ ¬°Datos sincronizados! Ya puedes usar el sistema en celulares.";
            msg.className = "alert alert-success";

        } catch (e) {
            msg.innerHTML = "‚ùå Error: " + e.message;
            msg.className = "alert alert-error";
        }
    }

    // Utilidades
    function nav(step) {
        for(let i=1; i<=5; i++) {
            const v = document.getElementById('view'+i);
            if(v) v.classList.add('hidden');
            const s = document.getElementById('s'+i);
            if(s) { s.classList.remove('active', 'done'); if(i<step) s.classList.add('done'); if(i==step) s.classList.add('active'); }
        }
        document.getElementById('view'+step).classList.remove('hidden');
    }

    function toggleAdmin() {
        document.getElementById('studentPanel').classList.toggle('hidden');
        document.getElementById('adminPanel').classList.toggle('hidden');
    }

    function adminLogin() {
        if(document.getElementById('adminPass').value === '1722769070') {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminTools').classList.remove('hidden');
        } else { alert("Contrase√±a incorrecta"); }
    }

    function showError(msg) {
        const e = document.getElementById('errorMsg');
        e.innerText = msg; e.classList.remove('hidden');
        setTimeout(() => e.classList.add('hidden'), 4000);
    }

    function fileCheck(id, statId) {
        document.getElementById(statId).innerText = "‚úÖ Archivo cargado";
    }

    function readExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
            };
            reader.readAsArrayBuffer(file);
        });
    }

    function findCol(row, keyPart) {
        const k = Object.keys(row).find(key => key.toLowerCase().includes(keyPart));
        return k ? row[k] : null;
    }
</script>

</body>
</html>
