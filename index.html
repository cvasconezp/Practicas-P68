<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Pr√°cticas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos optimizados */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        h1, h2, h3 { color: #4a5568; margin-bottom: 15px; text-align: center; }
        h1 { color: #667eea; }
        
        .btn { display: inline-block; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-secondary { background: #cbd5e0; color: #4a5568; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; }
        .hidden { display: none; }
        
        .upload-box { border: 2px dashed #cbd5e0; padding: 20px; text-align: center; margin-bottom: 15px; border-radius: 8px; }
        .status-msg { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; font-weight: bold; }
        .success { background: #c6f6d5; color: #22543d; }
        .error { background: #fed7d7; color: #822727; }
        .info { background: #bee3f8; color: #2a4365; }

        /* Steps */
        .step-dots { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; }
        .dot { width: 12px; height: 12px; background: #e2e8f0; border-radius: 50%; }
        .dot.active { background: #667eea; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align: right;">
        <button onclick="toggleAdmin()" style="background:none; border:none; color:#cbd5e0; cursor:pointer;">‚öôÔ∏è</button>
    </div>
    
    <h1>Gesti√≥n de Pr√°cticas</h1>
    <div id="loadingInfo" class="status-msg info hidden">‚è≥ Sincronizando datos con la nube...</div>

    <div id="studentView">
        <div class="step-dots">
            <div id="d1" class="dot active"></div><div id="d2" class="dot"></div><div id="d3" class="dot"></div><div id="d4" class="dot"></div>
        </div>

        <div id="step1">
            <h3>Paso 1: Identificaci√≥n</h3>
            <label>N√∫mero de C√©dula / ID:</label>
            <input type="text" id="searchId" placeholder="Ingresa tu ID aqu√≠">
            <button class="btn btn-primary" onclick="buscarEstudiante()">Buscar</button>
        </div>

        <div id="step2" class="hidden">
            <h3>Paso 2: Tus Datos</h3>
            <div id="studentInfoDisplay" style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:15px;"></div>
            
            <label>Correo Personal:</label>
            <input type="email" id="email">
            <label>Celular:</label>
            <input type="tel" id="phone">
            <label>Centro de Apoyo:</label>
            <select id="center">
                <option value="">Selecciona...</option>
                <option>Cayambe</option><option>Latacunga</option><option>Otavalo</option><option>Riobamba</option>
                <option>Quito</option><option>Guayaquil</option><option>Cuenca</option>
            </select>
            <label>Nivel:</label>
            <select id="level">
                <option value="">Selecciona...</option>
                <option>2do Nivel</option><option>4to Nivel</option><option>6to Nivel</option><option>8vo Nivel</option>
            </select>
            <button class="btn btn-primary" onclick="validarPaso2()">Siguiente</button>
            <button class="btn btn-secondary" onclick="setStep(1)">Atr√°s</button>
        </div>

        <div id="step3" class="hidden">
            <h3>Paso 3: Instituci√≥n</h3>
            <label>C√≥digo AMIE:</label>
            <input type="text" id="amie">
            <button class="btn btn-primary" onclick="buscarEscuela()">Buscar Escuela</button>
            <button class="btn btn-secondary" onclick="setStep(2)">Atr√°s</button>
        </div>

        <div id="step4" class="hidden">
            <h3>Paso 4: Confirmaci√≥n</h3>
            <div id="schoolInfoDisplay" style="background:#f7fafc; padding:15px; border-radius:8px; margin-bottom:15px;"></div>
            
            <label>Nombre Autoridad (Rector/L√≠der):</label>
            <input type="text" id="authName">
            <label>Cargo:</label>
            <select id="authRole">
                <option>Rector/a</option><option>Director/a</option><option>L√≠der</option>
            </select>
            <label>Tel√©fono Autoridad:</label>
            <input type="tel" id="authPhone">
            
            <button class="btn btn-success" onclick="enviarFormulario()">‚úÖ Enviar Registro</button>
            <button class="btn btn-secondary" onclick="setStep(3)">Atr√°s</button>
        </div>
    </div>

    <div id="adminView" class="hidden">
        <h2>Panel Administrativo</h2>
        <input type="password" id="adminPass" placeholder="Contrase√±a Admin">
        <button class="btn btn-secondary" onclick="checkAdmin()">Ingresar</button>
        
        <div id="adminPanelContent" class="hidden" style="margin-top:20px;">
            <label>URL de Google Apps Script:</label>
            <input type="text" id="scriptUrl" placeholder="https://script.google.com/.../exec">
            <button class="btn btn-primary" onclick="saveUrl()">Guardar URL</button>
            
            <hr style="margin:20px 0;">
            
            <div class="upload-box">
                <p>1. Archivo Estudiantes (Excel)</p>
                <input type="file" id="fileStudents" accept=".xlsx">
            </div>
            
            <div class="upload-box">
                <p>2. Archivo Escuelas (Excel)</p>
                <input type="file" id="fileSchools" accept=".xlsx">
            </div>
            
            <button class="btn btn-success" onclick="procesarArchivos()">üöÄ Subir a la Nube</button>
            <div id="uploadStatus" class="status-msg hidden"></div>
        </div>
        
        <button class="btn btn-secondary" onclick="toggleAdmin()" style="margin-top:20px;">Volver al Inicio</button>
    </div>

</div>

<script>
    // --- L√ìGICA DEL SISTEMA ---
    let DB_STUDENTS = [];
    let DB_SCHOOLS = [];
    let TEMP_DATA = {};
    let URL_SCRIPT = localStorage.getItem('script_url') || '';

    // Al iniciar: Intentar descargar datos de la nube
    window.onload = () => {
        if(URL_SCRIPT) {
            descargarDatosNube();
        } else {
            console.log("Falta URL del script");
        }
    };

    // --- COMUNICACI√ìN CON GOOGLE (GET y POST) ---
    
    // 1. DESCARGA (GET) - Para que funcione en m√≥viles
    async function descargarDatosNube() {
        document.getElementById('loadingInfo').classList.remove('hidden');
        try {
            // Usamos fetch GET simple para evitar CORS preflight complex
            const resEst = await fetch(`${URL_SCRIPT}?operation=loadStudents`);
            const jsonEst = await resEst.json();
            if(jsonEst.status === 'success') DB_STUDENTS = jsonEst.data;

            const resEsc = await fetch(`${URL_SCRIPT}?operation=loadSchools`);
            const jsonEsc = await resEsc.json();
            if(jsonEsc.status === 'success') DB_SCHOOLS = jsonEsc.data;

            console.log(`Datos cargados: ${DB_STUDENTS.length} estudiantes, ${DB_SCHOOLS.length} escuelas.`);
            document.getElementById('loadingInfo').classList.add('hidden');
        } catch (e) {
            console.error("Error descarga:", e);
            // Si falla, no mostramos error al usuario, solo en consola
            document.getElementById('loadingInfo').innerText = "Modo Offline (Datos locales)";
        }
    }

    // 2. SUBIDA (POST) - Para el Admin
    async function subirDatosNube(tipo, datos) {
        const payload = {
            operation: tipo === 'estudiantes' ? 'saveStudents' : 'saveSchools',
            [tipo === 'estudiantes' ? 'students' : 'schools']: datos
        };

        // Truco text/plain para evitar CORS en POST
        const res = await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        });
        return await res.json();
    }

    // 3. ENVIAR FORMULARIO (POST)
    async function enviarRegistroNube(datos) {
        const res = await fetch(URL_SCRIPT, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(datos)
        });
        return await res.json();
    }

    // --- FUNCIONES DE ESTUDIANTE ---

    function buscarEstudiante() {
        const id = document.getElementById('searchId').value.trim();
        // Buscamos en memoria (que se llen√≥ al cargar la p√°gina)
        const est = DB_STUDENTS.find(e => String(e.id).trim() === id);
        
        if (est) {
            TEMP_DATA.estudiante = est;
            document.getElementById('studentInfoDisplay').innerHTML = `
                <strong>${est.nombreCompleto}</strong><br>ID: ${est.id}<br>${est.correo}
            `;
            // Prellenar
            document.getElementById('email').value = est.correo || '';
            document.getElementById('phone').value = est.telefono || '';
            setStep(2);
        } else {
            alert("Estudiante no encontrado. Si est√°s en celular, aseg√∫rate de tener internet al abrir la p√°gina.");
        }
    }

    function buscarEscuela() {
        const amie = document.getElementById('amie').value.trim().toUpperCase();
        const esc = DB_SCHOOLS.find(e => String(e.id).toUpperCase().trim() === amie);
        
        if (esc) {
            TEMP_DATA.escuela = esc;
            document.getElementById('schoolInfoDisplay').innerHTML = `
                <strong>${esc.nombre}</strong><br>AMIE: ${esc.id}<br>${esc.distrito}
            `;
            setStep(4);
        } else {
            alert("Escuela no encontrada.");
        }
    }

    function validarPaso2() {
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const center = document.getElementById('center').value;
        const level = document.getElementById('level').value;
        
        if(!email.includes('@') || phone.length < 9 || !center || !level) {
            return alert("Completa todos los campos correctamente.");
        }
        
        TEMP_DATA.extra = { email, phone, center, level };
        setStep(3);
    }

    async function enviarFormulario() {
        const authName = document.getElementById('authName').value;
        const authRole = document.getElementById('authRole').value;
        const authPhone = document.getElementById('authPhone').value;
        
        if(!authName || !authPhone) return alert("Completa los datos de la autoridad");

        const registro = {
            fecha_hora: new Date().toLocaleString(),
            estudiante_id: TEMP_DATA.estudiante.id,
            estudiante_nombre_completo: TEMP_DATA.estudiante.nombreCompleto,
            estudiante_correo: TEMP_DATA.extra.email,
            estudiante_telefono: TEMP_DATA.extra.phone,
            estudiante_centro_apoyo: TEMP_DATA.extra.center,
            estudiante_nivel_practica: TEMP_DATA.extra.level,
            escuela_amie: TEMP_DATA.escuela.id,
            escuela_nombre: TEMP_DATA.escuela.nombre,
            escuela_distrito: TEMP_DATA.escuela.distrito,
            escuela_sistema: TEMP_DATA.escuela.sistema,
            autoridad_nombre: authName,
            autoridad_cargo: authRole,
            autoridad_telefono: authPhone
        };

        const btn = document.querySelector('#step4 .btn-success');
        btn.innerText = "Enviando...";
        btn.disabled = true;

        try {
            await enviarRegistroNube(registro);
            alert("‚úÖ ¬°Registro enviado correctamente!");
            location.reload();
        } catch (e) {
            alert("Hubo un error de conexi√≥n, intenta de nuevo.");
            btn.innerText = "Reintentar";
            btn.disabled = false;
        }
    }

    // --- FUNCIONES DE ADMIN ---

    function toggleAdmin() {
        document.getElementById('studentView').classList.toggle('hidden');
        document.getElementById('adminView').classList.toggle('hidden');
    }

    function checkAdmin() {
        if(document.getElementById('adminPass').value === '1722769070') {
            document.getElementById('adminPanelContent').classList.remove('hidden');
        } else {
            alert("Contrase√±a incorrecta");
        }
    }

    function saveUrl() {
        const url = document.getElementById('scriptUrl').value;
        localStorage.setItem('script_url', url);
        URL_SCRIPT = url;
        alert("URL Guardada. Refresca la p√°gina.");
    }

    async function procesarArchivos() {
        const f1 = document.getElementById('fileStudents').files[0];
        const f2 = document.getElementById('fileSchools').files[0];
        
        if(!f1 || !f2 || !URL_SCRIPT) return alert("Faltan archivos o la URL");
        
        const status = document.getElementById('uploadStatus');
        status.classList.remove('hidden');
        status.innerText = "‚è≥ Leyendo archivos...";
        status.className = 'status-msg info';

        try {
            // 1. Leer Estudiantes
            const dEst = await leerExcel(f1);
            const cleanEst = dEst.map(r => ({
                id: String(findCol(r, 'id') || ''),
                nombreCompleto: findCol(r, 'nombre') || findCol(r, 'estudiante') || '',
                correo: findCol(r, 'correo') || '',
                telefono: String(findCol(r, 'telefono') || findCol(r, 'celular') || '')
            }));

            // 2. Leer Escuelas
            const dEsc = await leerExcel(f2);
            const cleanEsc = dEsc.map(r => ({
                id: String(findCol(r, 'amie') || findCol(r, 'id') || ''),
                nombre: findCol(r, 'nombre') || '',
                distrito: findCol(r, 'distrito') || '',
                sistema: findCol(r, 'sistema') || ''
            }));

            status.innerText = "üöÄ Subiendo a Google Sheets...";
            
            // 3. Subir
            await subirDatosNube('estudiantes', cleanEst);
            await subirDatosNube('escuelas', cleanEsc);
            
            status.innerText = "‚úÖ ¬°Sincronizaci√≥n Completa! Ahora funcionar√° en celulares.";
            status.className = 'status-msg success';
            
        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå Error: " + e.message;
            status.className = 'status-msg error';
        }
    }

    function leerExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(file);
        });
    }

    function findCol(row, keyPart) {
        const key = Object.keys(row).find(k => k.toLowerCase().includes(keyPart));
        return key ? row[key] : null;
    }

    function setStep(n) {
        for(let i=1; i<=4; i++) {
            document.getElementById(`step${i}`).classList.add('hidden');
            document.getElementById(`d${i}`).classList.remove('active');
        }
        document.getElementById(`step${n}`).classList.remove('hidden');
        document.getElementById(`d${n}`).classList.add('active');
    }
</script>

</body>
</html>
